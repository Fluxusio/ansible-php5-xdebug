---
- name: Install unzip
  apt: name=unzip state=present install_recommends=no update_cache=yes cache_valid_time=3600
  sudo: yes

- name: Create temporary unzip location
  file: path=/tmp/drupal-latest state=directory

- name: Empty temporary unzip location
  shell: rm -rf /tmp/drupal-latest/*
  sudo: yes

- name: Copy Drupal archive
  unarchive:
    src={{ drupal_archive_path }}
    dest=/tmp/drupal-latest
  sudo: yes

- name: Rsync Drupal
  shell: rsync -ar --delete --exclude=sites/default/files/* /tmp/drupal-latest/docroot/ {{ drupal_docroot }}
  sudo: yes

- name: Set code permissions
  file: path={{ drupal_docroot }} state=directory owner={{ code_user | default('ubuntu') }} group={{ code_group | default('ubuntu') }} recurse=yes
  sudo: yes

- name: Install Drupal
  shell: drush si --root={{ drupal_docroot }} --uri={{ drupal_uri }} --account-pass={{ drupal_admin_pass }} --y --db-url={{ drupal_db_url }} --db-su={{ drupal_db_su}} --db-su-pw={{ drupal_db_su_pw}} {{ drupal_install_profile }} {{ drupal_install_extras | default('') }}
  sudo: yes
  sudo_user: "{{ code_user | default('ubuntu') }}"

- name: Set up local settings
  template: src=local_settings.php.j2 dest={{ drupal_docroot }}/sites/default/local_settings.php
  sudo: yes

- name: Local settings permissions
  file:
    path={{ drupal_docroot }}/sites/default/local_settings.php
    mode=0644
  sudo: yes

- name: Include local settings
  lineinfile:
    dest={{ drupal_docroot }}/sites/default/settings.php
    line="include dirname(__FILE__) . '/local_settings.php';"
    state=present
  sudo: yes

- name: Set files permissions
  file: 
    path={{ drupal_docroot }}/sites/default/files 
    state=directory owner={{ apache_user | default('www-data') }} 
    group={{ apache_user | default('www-data') }}
    recurse=yes
  sudo: yes

- name: Revert features
  shell: drush fra -y --root={{ drupal_docroot }} --uri={{ drupal_uri }}

- name: Clear cache
  shell: drush cc all --root={{ drupal_docroot }} --uri={{ drupal_uri }}

- name: Migrate content
  shell: drush en migrate tes_migrate_advertising --y --root={{ drupal_docroot }} --uri={{ drupal_uri }}; drush mi --all --root={{ drupal_docroot }} --uri={{ drupal_uri }}; drush dis migrate tes_migrate_advertising --y --root={{ drupal_docroot }} --uri={{ drupal_uri }}

